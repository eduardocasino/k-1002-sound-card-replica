
                              .PAGE  'DOCUMENTATION'
    3                ;        COPYRIGHT 1977 BY MICRO TECHNOLOGY UNLIMITED, BOX 4596,
    4                ;        MANCHESTER, NEW HAMPSHIRE 03108
    5                ;        PROGRAM WRITTEN BY HAL CHAMBERLIN
    6
    7                ;        THIS PROGRAM INTERPRETS NOTRAN OBJECT CODE GENERATED BY THE
    8                ;        NOTRAN COMPILER.
    9                ;        4 NON-DYNAMIC VOICES ARE SUPPORTED.
   10                ;        AN 8-BIT UNSIGNED DIGITAL-TO-ANALOG CONVERTER IS USED FOR THE
   11                ;        AUDIO OUTPUT,
   12                ;        OUTPUT SAMPLE RATE IS 8.77 KHZ WITH A 1.0 MHZ 6502 PROCESSOR
   13
   14                ;        THE INTERPRETIVE OBJECT CODE IS TIME-ORDERED IN MEMORY STARTING
   15                ;        AT THE ADDRESS IN "SONGA" AND ENDING AT AN END COMMAND BYTE OR
   16                ;        AN INFINITE LOOP.  EACH COMMAND IN THE OBJECT CODE CONSISTS OF
   17                ;        1, 2, OR 3 BYTES.  SOME COMMANDS ARE SPECIFICATIONS THAT TAKE
   18                ;        NO "TIME" THEMSELVES SUCH AS A TEMPO CHANGE SPECIFICATION.
   19                ;        OTHERS DIRECT THE PLAYING OF NOTES AND REQUIRE AN AMOUNT OF
   20                ;        TIME DETERMINED BY THEIR DURATION FIELD AND THE CURRENT TEMPO.
   21
   22                ;        THE FIRST BYTE OF A COMMAND IS THE COMMAND BYTE.  IT IS SPLIT
   23                ;        INTO TWO 4 BIT FIELDS, THE PITCH FIELD (UPPER HEX DIGIT) AND
   24                ;        THE DURATION FIELD (LOWER HEX DIGIT).  THE PITCH FIELD IS
   25                ;        INTERPRETED AS A SIGNED 4 BIT BINARY NUMBER.  IT REPRESENTS A
   26                ;        PITCH "DISPLACEMENT" FROM THE LAST NOTE PLAYED BY THE VOICE
   27                ;        BEING PROCESSED.  POSITIVE VALUES SPECIFY AN ASCENDING PITCH
   28                ;        WHILE NEGATIVE VALUES SPECIFY A DESCENDING PITCH.  THE VALUE-8
   29                ;        IS USED TO SPECIFY SILENCE FOR THE AFFECTED VOICE.  THUS
   30                ;        CONSECUTIVE NOTES MAY BE AT INTERVALS OF OVER A HALF OCTAVE
   31                ;        WITHOUT REQUIRING THE MULTI-BYTE LONG NOTE SPECIFICATION TO BE
   32                ;        USED.  THE RELATIVE NATURE OF THE NOTES IS ALSO USEFUL IN
   33                ;        "MUSICAL SUBROUTINES" TO BE DESCRIBED.
   34
   35                ;        THE DURATION FIELD SPECIFIES THE DURATION OF THE SPECIFIED
   36                ;        PITCH FOR THE CURRENT VOICE.  THE DURATION CODE IS AS FOLLOWS:
   37
   38                ;          0 = CONTROL ESCAPE           8 = QUARTER-TRIPLET (1/6)
   39                ;          1 = WHOLE NOTE               9 = EIGHTH NOTE
   40                ;          2 = DOTTED HALF NOTE         A = DOTTED SIXTEENTH NOTE
   41                ;          3 = HALF NOTE                B = EIGHTH-TRIPLET (1/12)
   42                ;          4 = DOTTED QUARTER NOTE      C = SIXTEENTH NOTE
   43                ;          5 = HALF-TRIPLET (1/3)       D = DOTTED THIRTY-SECOND NOTE
   44                ;          6 = QUARTER NOTE             E = SIXTEENTH-TRIPLET (1/24)
   45                ;          7 = DOTTED EIGHTH NOTE       F = THIRTY-SECOND NOTE
   46
   47                ;        NOTE THAT IF THE DURATION CODE IS ZERO THEN THE PITCH FIELD IS
   48                ;        INTERPRETED AS FOLLOWS:
   49
   50                ;          0 = END OF SONG, RETURN TO KIM-1 MONITOR
   51                ;          1 = CHANGE OF TEMPO, NEXT BYTE IS A NEW TEMPO BYTE
   52                ;          2 = CALL TO A MUSICAL SUBROUTINE, TWO BYTE SUBROUTINE ADDRESS
   53                ;              FOLLOWS, LOW BYTE FIRST
   54                ;          3 = RETURN FROM A MUSICAL SUBROUTINE
   55                ;          4 = UNCONDITIONAL JUMP, TWO BYTE JUMP ADDRESS FOLLOWS
   56                ;          5 = SET NUMBER OF VOICES, NUMBER BETWEEN 1 AND 4 IN NEXT BYTE
   57                ;          6 = LONG NOTE SPECIFICATION WITH ABSOLUTE PITCH SPECIFICATION
   58                ;              2 ADDITIONAL BYTES FOLLOW
   59                ;          7 = LONG NOTE SPECIFICATION WITH RELATIVE PITCH SPECIFICATION
   60                ;              2 ADDITIONAL BYTES FOLLOW
   61                ;          8 = DEACTIVATE VOICE, VOICE NUMBER TO DEACTIVATE IN NEXT BYTE
   62                ;          9 = ACTIVATE VOICE, VOICE NUMBER TO ACTIVATE IN NEXT BYTE
   63                ;          A-F RESERVED FOR FUTURE EXPANSION, IF USED CAUSES RETURN TO
   64                ;              KIM MONITOR
   65
   66                ;        A LONG NOTE SPECIFICATION CONSISTS OF TWO ADDITIONAL BYTES AS
   67                ;        FOLLOWS:
   68                ;        BYTE 1 - PITCH; IF ABSOLUTE, IT IS TREATED AS RELATIVE TO THE
   69                ;                 BEGINNING OF THE NOTE FREQUENCY TABLE.  IF RELATIVE,
   70                ;                 IT IS TREATED AS RELATIVE TO THE LAST PITCH SOUNDED
   71                ;                 BY THE CURRENT VOICE. IN EITHER CASE IT IS A SIGNED,
   72                ;                 TWOS COMPLEMENT NUMBER.
   73                ;        BYTE 2 - UPPER DIGIT, WAVEFORM TABLE NUMBER.  THIS IS ADDED
   74                ;                 TO THE PAGE ADDRESS OF THE WAVEFORM TABLE AREA TO
   75                ;                 YEILD THE PAGE ADDRESS OF THE WAVEFORM TABLE TO BE
   76                ;                 USED FOR THIS VOICE.
   77                ;                 LOWER DIGIT - DURATION CODE AS LISTED PREVIOUSLY.
   78                ;                 A ZERO DURATION IS ILLEGAL.
   79
   80                ;        WHEN SELECTING THE WAVEFORM TABLES TO BE ASSIGNED TO THE VOICES
   81                ;        IT IS IMPORTANT THAT OVERFLOW WHEN THE VOICES ARE COMBINED IS
   82                ;        AVOIDED.  WHEN CHECKING FOR AN OVERFLOW POSSIBILITY, AN
   83                ;        INACTIVE VOICE STILL CONTRIBUTES TO THE SUM (AN INACTIVE VOICE
   84                ;        MERELY HAS A ZERO FREQUENCY) WHEREAS A DISABLED VOICE DOES NOT
   65                ;        (IT IS NOT SUMMED).  TO DETERMINE IF OVERFLOW IS POSSIBLE, ADD
   86                ;        UP THE LARGEST SAMPLE FROM THE WAVEFORM TABLE CORRESPONDING TO
   87                ;        EACH ENABLED VOICE AND VERIFY THAT THE SUM IS 255 OR LESS.  AN
   88                ;        ABSOLUTELY SAFE WAY TO AVOID OVERFLOW IS TO SPECIFY WHEN THE
   89                ;        WAVEFORM IS CREATED WITH THE FOURIER SERIES PROGRAM AN
   90                ;        AMPLITUDE OF 255/N WHERE N IS THE NUMBER OF ENABLED VOICES.
   91                ;        HOWEVER BY PROPERLY UNDERSTANDING THE OVERFLOW RESTRICTION ONE
   92                ;        MAY MAKE SOME VOICES LOUDER THAN OTHERS AND EVEN IMPLEMENT
   93                ;        LIMITED DYNAMICS.  NOTE THAT ACTIVATING OR DEACTIVATING A VOICE
   94                ;        IS NOISELESS WHEREAS ENABLING OR DISABLING ONE MAY BE
   95                ;        ACCOMPANIED BY A CLICK.
   96
   97                ;        VOICE 1 IS ALWAYS ENABLED.  ENABLED VOICES MUST ALWAYS BE IN
   98                ;        SEQUENCE STARTING FROM VOICE 1.  AS AN EXAMPLE, IF THE NUMBER
   99                ;        OF VOICES IS SET TO 3, THEN VOICES 1 - 2 ARE EANBLED AND VOICE
  100                ;        4 IS DISABLED.
  101
  102                ;               RULES FOR INTERPRETING NOTRAN OBJECT CODE
  103
  104                ;        WHEN THE INTERPRETER IS INITIALLY ENTERED, ALL 4 VOICES WILL BE
  105                ;        DEACTIVATED AND INTERPRETATION WILL START AT THE ADDRESS IN
  106                ;        SONGA.  THE INTERPRETER EXPECTS TO SEE PURE CONTROL COMMANDS
  107                ;        (DURATION FIELD = 0 AND PITCH FIELD BETWEEN 0 AND B) FIRST.  AT
  108                ;        THE BEGINNING OF A SONG, AT LEAST ONE WOULD BE USED TO SET UP
  109                ;        THE TEMPO.  AT OTHER TIMES THEY ARE USED TO CHANGE THE TEMPO,
  110                ;        DEACTIVATE VOICES THAT WILL BE SILENT FOR A TIME, ACTIVATE
  111                ;        VOICES THAT HAVE BEEN IDLE, ALTER THE FLOW OF CONTROL THROUGH
  112                ;        JUMPS OR SUBROUTINE CALLS, AND TO MARK THE END OF THE SONG.
  113
  114                ;        FOLLOWING THE PURE CONTROL COMMANDS, IF ANY, NOTE COMMANDS ARE
  115                ;        EXPECTED.  AT THE BEGINNING OF A SONG LONG NOTE COMMANDS MUST
  116                ;        BE USED TO ESTABLISH THE WAVEFORMS TO BE USED WITH EACH VOICE
  117                ;        AND ESTABLISH A PITCH REFERENCE FOR THE RELATIVE PITCHES THAT
  118                ;        MAY APPEAR LATER.  AT OTHER TIMES LONG NOTE COMMANDS MAY BE
  119                ;        USED TO CHANGE WAVEFORMS AND ADDRESS PITCHES THAT ARE
  120                ;        UNREACHABLE WITH THE RELATIVE PITCH SPECIFICATION IN A SHORT
  121                ;        NOTE COMMAND.  SHORT NOTE COMMANDS (DURATION FIELD IS NON-ZERO)
  122                ;        MAY BE FREELY INTERMIXED WITH LONG NOTE COMMANDS AND SHOULD BE
  123                ;        USED WHEN POSSIBLE TO MINIMIZE THE AMOUNT OF STORAGE REQUIRED
  124                ;        FOR A SONG.
  125
  126                ;        NOTE COMMANDS ARE SUCCESSIVELY FETCHED, INTERPRETED, AND
  127                ;        ASSINGED IN ORDER TO ACTIVE VOICES WHOSE NOTES HAVE EXPIRED
  128                ;        UNTIL ALL OF THE ACTIVE VOICES HAVE BEEN SATISFIED.  SINCE ALL
  129                ;        NOTE COMMANDS LACK A FIELD THAT SPECIFICALLY ASSIGNS THE NOTE
  130                ;        TO A PARTICULAR VOICE, THEY ARE ASSIGNED TO EXPIRED ACTIVE
  131                ;        VOICES IN SEQUENCE STARTING WITH VOICE 1.  WHEN ALL EXPIRED
  132                ;        ACTIVE VOICES HAVE BEEN LOADED UP, THEY PLAY THEIR NOTES UNTIL
  133                ;        THE ONE WITH THE SHORTEST DURATION RUNS OUT, THEN THE
  134                ;        INTERPRETER REGAINS CONTROL EXPECTING PURE CONTROL COMMANDS
  135                ;        AGAIN.
  136
                              .PAGE  'EQUATES AND BASE PAGE STORAGE'
  137
  138 0000                    .=     0            ; ORG AT PAGE 0 LOCATION 0
  139
  140 1700           DAC      =      X'1700       ; OUTPUT PORT ADDRESS WITH DAC
  141 1701           DACDIR   =      X'1701       ; DATA DRIECTION REGISTER FOR DAC PORT
  142 1C22           KIMMON   =      X'1C22       ; ENTRY POINT TO KIM KEYBOARD MONITOR
  143 00FF           ISTKPT   =      X'FF         ; INITIAL VALUE OF STACK POINTER
  144
  145                                             ; FORMAT OF TABLE AREA FOR VOICE X
  146 0000           VXPTF    =      0            ; VOICE WAVE POINTER, FRACTIONAL PART
  147 0001           VXPTI    =      1            ; INTEGER PART
  148 0002           VXPTW    =      2            ; WAVE TABLE PAGE NUMBER
  149 0003           VXNOT    =      3            ; DISPLACEMENT IN NOTE FREQUENCY TABLE
  150 0004           VXIN     =      4            ; WAVE TABLE POINTER INCREMENT (FREQUENCY
  151                                             ; PARAMETER, DOUBLE PRECISION)
  152 0006           VXDUR    =      6            ; NOTE DURATION
  153
  154                ;        ADDRESSES OF OBJECT CODE AREA AND WAVEFORM TABLE AREA
  155
  156 0000 0000      SONGA:   .WORD  0            ; ADDRESS OF OBJECT CODE AREA
  157 0002 0000      WAVTBA:  .WORD  0            ; ADDRESS OF WAVEFORM TABLE AREA
  158
  159                ;        STORAGE REQUIRED BY THE INTERPRETER
  160
  161 0004 0000      CODEPT:  .WORD  0            ; OBJECT CODE POINTER
  162 0006 00        TEMPO:   .BYTE  0            ; TEMPO CONTROL VALUE
  163 0007 00        DUR:     .BYTE  0            ; EVENT DURATION
  164 0008 00        DURC:    .BYTE  0            ; EVENT DURATION COUNTER
  165 0009           V1TBA:   .=.+   8            ; 8 BYTES FOR VOICE 1 TABLE AREA + 1 SPARE
  166 0011           V2TBA:   .=.+   8            ; 8 BYTES FOR VOICE 2 TABLE AREA + 1 SPARE
  167 0019           V3TBA:   .=.+   8            ; 8 BYTES FOR VOICE 3 TABLE AREA + 1 SPARE
  168 0021           V4TBA:   .=.+   8            ; 8 BYTES FOR VOICE 4 TABLE AREA + 1 SPARE
  169 0029 00        XSAVE:   .BYTE  0            ; AREA FOR QUICK SAVE OF X
  170 002A 00        YSAVE:   .BYTE  0            ; AREA FOR QUICK SAVE OF Y
  171 002B 00        CMSAVE:  .BYTE  0            ; AREA FOR SAVING COMMAND BYTE
  172 002C 0F        CTLM:    .BYTE  X'0F         ; MASK FOR TESTING DURATION FIELD
  173 002D 3E00      NULSMP:  .WORD  FRQTAB       ; ADDRESS OF NULL SAMPLE FOR USE IN
  174                                             ; EFFECTIVELY REDUCING NUMBER OF VOICES
  175                                             ; ADDED UP
  176
  177                         ; NOTE DURATION TABLE
  178
  179 002F C0        DURTAB:  .BYTE  192          ; 1 WHOLE NOTE
  180 0030 90                 .BYTE  144          ; 2 DOTTED HALF NOTE
  181 0031 60                 .BYTE  96           ; 3 HALF NOTE
  182 0032 48                 .BYTE  72           ; 4 DOTTED QUARTER NOTE
  183 0033 40                 .BYTE  64           ; 5 HALF NOTE TRIPLET
  184 0034 30                 .BYTE  48           ; 6 QUARTER NOTE
  185 0035 24                 .BYTE  36           ; 7 DOTTED EIGHTH NOTE
  186 0036 20                 .BYTE  32           ; 8 QUARTER NOTE TRIPLET
  187 0037 18                 .BYTE  24           ; 9 EIGHTH NOTE
  188 0038 12                 .BYTE  18           ; A DOTTED SIXTEENTH NOTE
  189 0039 10                 .BYTE  16           ; B EIGHTH NOTE TRIPLET
  190 003A 0C                 .BYTE  12           ; C SIXTEENTH NOTE
  191 003B 09                 .BYTE  9            ; D DOTTED 1/32 NOTE
  192 003C 08                 .BYTE  8            ; E SIXTEENTH NOTE TRIPLET
  193 003D 06                 .BYTE  6            ; F 1/32 NOTE
  194
  195                ;        NOTE FREQUENCY TABLE FOR 8.772 KHZ SAMPLE RATE
  196                ;        RANGE FROM C1 (32.7 HZ) TO C6 (1046.5 HZ)
  197                ;                               ID  NOTE  FREQ.   INCR.
  198 003E 0006      FRQTAB:  .BYTE  0,0          ;  00  SILENCE
  199 0040 00F4               .BYTE  0,244        ;  02  C1    32.702  .95445
  200 0042 0103               .BYTE  1,3          ;  04  C1#   34.647  1.0112
  201 0044 0112               .BYTE  1,18         ;  06  D1    36.707  1.0713
  202 0046 0123               .BYTE  1,35         ;  08  D1#   38.891  1.1350
  203 0048 0134               .BYTE  1,52         ;  0A  E1    41.204  1.2025
  204 004A 0146               .BYTE  1,70         ;  0C  F1    43.654  1.2740
  205 004C 015A               .BYTE  1,90         ;  0E  F1#   46.249  1.3498
  206 004E 016E               .BYTE  1,110        ;  10  G1    48.999  1.4300
  207 0050 0184               .BYTE  1,132        ;  12  G1#   51.915  1.5151
  208 0052 019B               .BYTE  1,155        ;  14  A1    55.000  1.6052
  209 0054 01B3               .BYTE  1,179        ;  16  A1#   58.270  1.7006
  210 0056 01CD               .BYTE  1,205        ;  18  B1    61.735  1.8017
  211 0058 01E9               .BYTE  1,233        ;  1A  C1    65.405  1.9089
  212 005A 0206               .BYTE  2,6          ;  1C  C1#   69.295  2.0224
  213 005C 0225               .BYTE  2,37         ;  1E  D2    73.415  2.1427
  214 005E 0245               .BYTE  2,69         ;  20  D2#   77.783  2.2701
  215 0060 0268               .BYTE  2,104        ;  22  E2    82.408  2.4051
  216 0062 028C               .BYTE  2,140        ;  24  F2    87.308  2.5481
  217 0064 02B3               .BYTE  2,179        ;  26  F2#   92.498  2,6996
  218 0066 02DC               .BYTE  2,220        ;  28  G2    97.998  2.8601
  219 0068 0308               .BYTE  3,8          ;  2A  G2#   103.83  3.0302
  220 006A 0336               .BYTE  3,54         ;  2C  A2    110.00  3.2104
  221 006C 0367               .BYTE  3,103        ;  2E  A2#   116.54  3.4013
  222 006E 039A               .BYTE  3,154        ;  30  B2    123.47  3.6035
  223 0070 03D1               .BYTE  3,209        ;  32  C3    130.81  3.8178
  224 0072 040B               .BYTE  4,11         ;  34  C3#   138.59  4.0448
  225 0074 0449               .BYTE  4,73         ;  36  D3    146.83  4.2854
  226 0076 048A               .BYTE  4,138        ;  38  D3#   155.57  4.5402
  227 0078 04CF               .BYTE  4,207        ;  3A  E3    164.82  4.8102
  228 007A 0519               .BYTE  5,25         ;  3C  F3    174.62  5.0962
  229 007C 0566               .BYTE  5,102        ;  3E  F3#   185.00  5.3992
  230 007E 05B8               .BYTE  5,184        ;  40  G3    196.00  5.7203
  231 0080 060F               .BYTE  6,15         ;  42  G3#   207.65  6.0604
  232 0082 066C               .BYTE  6,108        ;  44  A3    220.00  6.4208
  233 0084 06CD               .BYTE  6,205        ;  46  A3#   233.08  6.8026
  234 0086 0735               .BYTE  7,53         ;  48  B3    246.94  7.2071
  235 0088 07A3               .BYTE  7,163        ;  4A  C4    261.62  7.6356
  236 008A 0817               .BYTE  8,23         ;  4C  C4#   277.18  8.0897
  237 008C 0892               .BYTE  8,146        ;  4E  D4    293.66  8.5707
  238 008E 0915               .BYTE  9,21         ;  50  D4#   311.13  9.0804
  239 0090 099F               .BYTE  9,159        ;  52  E4    329.63  9.6203
  240 0092 0A31               .BYTE  10,49        ;  54  F4    349.23  10.1924
  241 0094 0ACC               .BYTE  10,204       ;  56  F4#   369.99  10.7984
  242 0096 0B71               .BYTE  11,113       ;  58  G4    391.99  11.4405
  243 0098 0C1F               .BYTE  12,31        ;  5A  G4    415.30  12.1208
  244 009A 0CD7               .BYTE  12,215       ;  5C  A4    440.00  12.8416
  245 009C 0D9B               .BYTE  13,155       ;  5E  A4#   466.16  13.6052
  246 009E 0E6A               .BYTE  14,106       ;  60  B4    493.88  14.4142
  247 00A0 0F45               .BYTE  15,69        ;  62  C5    523.24  15.2713
  248 00A2 102E               .BYTE  16,46        ;  64  C5#   554.36  16.1794
  249 00A4 1124               .BYTE  17,36        ;  66  D5    587.32  17.1414
  250 00A6 1229               .BYTE  18,41        ;  68  D5#   622.26  18.1607
  251 00A8 133E               .BYTE  19,62        ;  6A  E5    659.26  19.2406
  252 00AA 1462               .BYTE  20,98        ;  6C  F5    698.46  20.3847
  253 00AC 1599               .BYTE  21,153       ;  6E  F5#   739.98  21.5969
  254 00AE 16E2               .BYTE  22,226       ;  70  G5    783.98  22.8811
  255 00B0 183E               .BYTE  24,62        ;  72  G5#   830.60  24.2417
  256 00B2 19AF               .BYTE  25,175       ;  74  A5    880.00  25.6831
  257 00B4 1B36               .BYTE  27,54        ;  76  A5#   932.32  27.2103
  258 00B6 1CD4               .BYTE  28,212       ;  78  B5    987.76  28.8283
  259 00B8 1E8B               .BYTE  30,139       ;  7A  C6    1046.5  30.5426
  260
  261                ;        JUMP TABLE FOR INTERPRETING PURE CONTROL COMMANDS
  262
  263 00BA 0000      JADDR:   .WORD  0            ; INDIRECT JUMP POINTER
  264 00BC 221C      JTAB:    .WORD  KIMMON       ; 00 RETURN TO KIM MONITOR
  265 00BE 4D02               .WORD  PCC10        ; 10 TEMPO SET
  266 00CO 5602               .WORD  PCC20        ; 20 MUSICAL SUBROUTINE CALL
  267 00C2 7302               .WORD  PCC30        ; 30 RETURN FROM MUSICAL SUBROUTINE
  268 00C4 5E02               .WORD  PCC40        ; 40 UNCONDITIONAL JUMP
  269 00C6 8102               .WORD  PCC50        ; 90 SET NUMBER OF VOICES
  270 00C8 B302               .WORD  NOTE         ; 60 LONG NOTE WITH ABSOLUTE PITCH
  271 00CA B302               .WORD  NOTE         ; 70 LONG NOTE WITH RELATIVE PITCH
  272 00CC 8B02               .WORD  PCC80        ; 80 ACTIVATE VOICE
  273 00CE A202               .WORD  PCC90        ; 90 DEACTIVATE VOICE
  274 00D0 221C               .WORD  KIMMON       ; A0 UNDEFINED
  275 00D2 221C               .WORD  KIMMON       ; B0 UNDEFINED
  276 00D4 221C               .WORD  KIMMON       ; C0 UNDEFINED
  277 00D6 221C               .WORD  KIMMON       ; D0 UNDEFINED
  278 00D8 221C               .WORD  KIMMON       ; E0 UNDEFINED
  279 00DA 221C               .WORD  KIMMON       ; F0 UNDEFINED
  280
                              .PAGE  'INITIALIZATION'
  281                ;        INITIALIZATION ROUTINE
  282                ;        INITIALIZE THE MUSIC HARDWARE, SET UP THE OBJECT CODE POINTER,
  283                ;        AND DEACTIVATE ALL 4 VOICES
  284
  285 00DC                    .=     X'200        ; START INTERPRETER AT 200
  286
  287 0200 A9FF      MUSIC:   LDA    #X'FF        ; SET DAC PORT DATA DIRECTION REGISTER TO
  288 0202 8D0117             STA    DACDIR       ; OUTPUT
  289 0205 D8                 CLD                 ; INSURE BINARY ARITHMETIC
  290 0206 A2FF               LDX    #ISTKPT      ; INITIALIZE STACK POINTER
  291 0208 9A                 TXS
  292 0209 A900               LDA    #0           ; ZERO THE PREVIOUS DURATION
  293 020B 8507               STA    DUR
  294 020D A500               LDA    SONGA        ; INITIALIZE OBJECT CODE POINTER TO
  295 020F 8504               STA    CODEPT       ; BEGINNING OF ORJECT CODE
  296 0211 A501               LDA    SONGA+1
  297 0213 8505               STA    CODEPT+1
  298
  299 0215 A200               LDX    #0           ; INITIALIZE ALL 4 VOICES
  300 0217 A900      DEACT:   LDA    #0
  301 0219 950D               STA    V1TBA+VXIN,X ; ZERO THE WAVE TABLE INCREMENT FOR SILENCE
  302 021B 950E               STA    V1TBA+VXIN+1,X
  303 021D A9FF               LDA    #X'FF        ; SET THE VOICE DURATION TO FF TO
  304 021F 950F               STA    V1TBA+VXDUR,X; DEACTIVATE
  305 0221 A503               LDA    WAVTBA+1     ; INITIALLY ASSIGN WAVEFORM 1 TO ALL VOICES
  306 0223 950B               STA    V1TBA+VXPTW,X
  307 0225 8A                 TXA                 ; BUMP INDEX UP TO NEXT VOICE
  308 0226 18                 CLC
  309 0227 6908               ADC    #8
  310 0229 AA                 TAX
  311 022A C920               CMP    #32          ; TEST IF DONE
  312 022C D0E9               BNE    DEACT        ; LOOP UNTIL 4 VOICES DONE
  313 022E A904               LDA    #4           ; SET NUMBER OF VOICES TO 4
  314 0230 20CB03             JSR    SETNV
  315
                              .PAGE  'CODE SEGMENT INTERPRETER'
  316                ;        INTERPRET CODE SEGMENTS UNTIL ALL ACTIVE, UNEXPIRED VOICES HAVE
  317                ;        BEEN SATISFIED AND THEN GO TO THE SOUND GENERATION ROUTINE
  318
  319                ;        INITIALLY A "PURE CONTROL COMMAND" IS EXPECTED
  320
  321 0233 A000      PCC:     LDY    #0           ; INITIALIZE INDEX Y TO POINT TO FIRST BYTE
  322                                             ; OF CODE SEGMENT
  323 0234 B104      PCC1:    LDA    (CODEPT),Y   ; GET FIRST BYTE OF CODE SEGMENT
  324 0237 242C               BIT    CTLM         ; TEST IF LOW HEX DIGIT IS ZERO
  325 0239 F003               BEQ    PCC2
  326 023B 4CB302             JMP    NOTE         ; JUMP IF NOT, IT IS A SHORT NOTE COMMAND
  327 023E 4A        PCC2:    LSRA                ; PERFORM A VECTOR JUMP ON THE HIGH HEX
  328 023F 4A                 LSRA                ; DIGIT
  329 0240 4A                 LSRA
  330 0241 AA                 TAX
  331 0242 B58C               LDA    JTAB,X
  332 0244 85BA               STA    JADDR
  333 0246 B5BD               LDA    JTAB+1,X
  334 0248 85BB               STA    JADDR+1
  335 024A 6CBA00             JMP    (JADDR)
  336
  337                ;        PROCESS TEMPO CHANGE COMMAND
  338
  339 024D C8        PCC10:   INY                 ; GET NEXT BYTE FROM CODE STRING
  340 024E B104               LDA    (CODEPT),Y
  341 0250 8506               STA    TEMPO        ; UPDATE THE TEMPO
  342 0252 C8                 INY
  343 0253 4C3502             JMP    PCC1         ; GO FOR NEXT COMMAND
  344
  345                ;        PROCESS MUSICAL SUBROUTINE CALL
  346
  347 0256 A504      PCC20:   LDA    CODEPT       ; SAVE CURRENT VALUE OF OBJECT CODE POINTER
  348 0258 48                 PHA                 ; ON THE STACK
  349 0259 A505               LDA    CODEPT+1
  350 025B 48                 PHA                 ; AND PROCESS THE NEXT 2 BYTES AS AN
  351 025C 98                 TYA                 ; UNCONDITIONAL JUMP
  352 025D 48                 PHA
  353
  354                ;        PROCESS AN UNCONDITIONAL JUMP
  355
  356 025E C8        PCC40:   INY                 ; GET NEXT TWO BYTES FROM THE CODE STRING
  357 025F B104               LDA    (CODEPT),Y
  358 0261 18                 CLC                 ; AND ADD THEM TO THE CODE STRING ORIGIN
  359 0262 6500               ADC    SONGA        ; FOR RELATIVE ADDRESSING WITHIN OBJECT
  360 0264 AA                 TAX                 ; CODE
  361 0265 C8                 INY
  362 0266 B104               LDA    (CODEPT),Y
  363 0268 6501               ADC    SONGA+1
  364 026A 8505               STA    CODEPT+1     ; STORE THEM IN THE CODE STRING POINTER
  365 026C 8604               STX    CODEPT
  366 026E A000               LDY    #0           ; ZERO THE INDEX FACTOR
  367 0270 4C3502             JMP    PCC1         ; GO FOR NEXT COMMAND
  368
  369                ;        PROCESS A RETURN FROM MUSICAL SUBROUTINE
  370
  371 0273 68        PCC30:   PLA                 ; POP THE SAVED CODE POINTER FROM THE STACK
  372 0274 A8                 TAY
  373 0275 68                 PLA
  374 0276 8505               STA    CODEPT+1
  375 0278 68                 PLA
  376 0279 8504               STA    CODEPT
  377 027B C8                 INY                 ; INCREMENT THE SAVED INDEX FACTOR BY 3
  378 027C C8                 INY
  379 027D C8                 INY
  380 027F 4C3502             JMP    PCC1         ; AND GO FOR THE NEXT COMMAND
  381
  382                ;        PROCESS A SET NUMBER OF VOICES COMMAND
  383
  384 0281 C8        PCC50:   INY                 ; GET SPECIFIED NUMBER OF VOICES
  385 0282 B104               LDA    (CODEPT),Y   ; FROM NEXT CODE BYTE
  386 0284 20CB03             JSR    SETNV        ; DO INSTRUCTION MODIFICATION IN SOUND
  387                                             ; GENERATE ROUTINE TO SET THE NUMBER OF
  388 0287 C8                 INY                 ; VOICES
  389 0288 4C3502             JMP    PCC1         ; GO FOR NEXT COMMAND
  390
  391                ;        PROCESS A DEACTIVATE VOICE COMMAND
  392
  393 028B C8        PCC80:   INY                 ; GET SPECIFIED VOICE NUMBER TIMES 8
  394 028C B104               LDA    (CODEPT),Y
  395 028E 2903               AND    #X'03        ; RESTRICT RANGE TO 0 - 3
  396 0290 0A                 ASLA
  397 0291 0A                 ASLA
  398 0292 0A                 ASLA
  399 0293 AA                 TAX                 ; PUT IT INTO X
  400 0294 A9FF               LDA    #X'FF        ; SET THE DURATION BYTE IN THE SPECIFIED
  401 0296 950F               STA    V1TBA+VXDUR,X; VOICE TO FF TO DEACTIVATE IT
  402 0298 A900               LDA    #0           ; ZERO THE WAVE TABLE INCREMENT FOR SILENCE
  403 029A 950D               STA    V1TBA+VXIN,X
  404 029C 950E               STA    V1TBA+VXIN+1,X
  405 029E C8                 INY                 ; INCREMENT THE CODE STRING POINTER
  406 029F 4C3502             JMP    PCC1         ; GO FOR NEXT COMMAND
  407
  408                ;        PROCESS AN ACTIVATE VOICE COMMAND
  409
  410 02A2 C8        PCC90:   INY                 ; COMPUTE SPECIFIED VOICE NUMBER TIMES 8
  411 02A3 B104               LDA    (CODEPT),Y
  412 02A5 2903               AND    #X'03
  413 02A7 0A                 ASLA
  414 02A8 0A                 ASLA
  415 02A9 0A                 ASLA
  416 02AA AA                 TAX                 ; PUT IT INTO INDEX X
  417 02AB A900               LDA    #0           ; SET THE DURATION BYTE IN THE SPECIFIED
  418 02AD 950F               STA    V1TBA+VXDUR,X; VOICE TO 0 TO ACTIVATE IT
  419 02AF C8                 INY                 ; INCREMENT THE CODE STRING POINTER
  420 02B0 4C3502             JMP    PCC1         ; GO FOR NEXT COMMAND
  421
  422                ;        NOTE COMMANDS ARE EXPECTED HERE.  SCAN THROUGH THE VOICES IN
  423                ;        SEQUENCE SKIPPING ANY INACTIVE ONES.  IF VXDUR IS ZERO, FETCH A
  424                ;        COMMAND FROM THE CODE STRING WHICH IS EXPECTED TO BE A NOTE
  425                ;        COMMAND AND INTERPRET IT ASSIGNING THE RESULTS TO THE CURRENT
  426                ;        VOICE.  WHEN ALL VOICES HAVE BEEN PROCESSED, GO PLAY THE NOTES.
  427
  428 02B3 A200      NOTE:    LDX   #0           ; INITIALIZE CURRENT VOICE POINTER
  429 02B5 B50F      NOTE1:   LDA   V1TBA+VXDUR,X; GET DURATION BYTE OF CURRENT VOICE
  430 02B7 F00B               BEQ   NOTE2        ; JUMP IF NEWLY ACTIVATED
  431 02B9 C9FF               CMP   #X'FF
  432 02BB F038               BEQ   NOTE9        ; SKIP THIS VOICE IF INACTIVE
  433 02BD 38                 SEC                ; SUBTRACT PREVIOUS DURATION
  434 02BE E507               SBC   DUR
  435 02C0 950F               STA   V1TBA+VXDUR,X; STORE RESULT BACK
  436 02C2 D031               BNE   NOTE9        ; SKIP THIS VOICE IF UNEXPIRED
  437 02C4 B104      NOTE2:   LDA   (CODEPT),Y   ; GET A COMMAND BYTE
  438 02C6 852B               STA   CMSAVE       ; SAVE THE COMMAND BYTE
  439 02C8 290F               AND   #X'0F        ; ISOLATE THE DURATION FIELD AND
  440 02CA F035               BEQ   LNOTE        ; JUMP OUT IF NOT A SHORT NOTE COMMAND
  441 02CC 842A               STY   YSAVE        ; SAVE Y
  442 02CE A8                 TAY                ; GET DURATION VALUE CORRESPONDING TO
  443 02CF B92E00             LDA   DURTAB-1,Y   ; CONTENTS OF DURATION FIELD AND
  444 02D2 950F               STA   V1TBA+VXDUR,X; PUT INTO DURATION BYTE OF CURRENT VOICE
  445 02D4 A52B               LDA   CMSAVE       ; GET THE COMMAND BYTE BACK
  446 02D6 29F0               AND   #X'F0        ; ISOLATE THE PITCH DISPLACEMENT
  447 02D8 18                 CLC                ; CONVERT TWO'S COMPLEMENT TO EXCESS 8
  448 02D9 6980               ADC   #X'80
  449 02DB F00A               BEQ   NOTE3        ; SKIP AHEAD IF -8 = REST
  450 02DD 4A                 LSRA               ; RIGHT JUSTIFY THE PITCH DISPLACEMENT
  451 02DE 4A                 LSRA               ; TIMES TWO
  452 02DF 4A                 LSRA
  453 02E0 750C               ADC   V1TBA+VXNOT,X; ADD RESULT TO CURRENT PITCH BYTE
  454 02E2 18                 CLC
  455 02E3 69F0               ADC   #-16         ; SUBTRACT OUT THE EXCESS 8 OFFSET
  456 02E5 950C               STA   V1TBA+VXNOT,X; UPDATE THE CURRENT PITCH BYTE
  457 02E7 A8        NOTE3:   TAY                ; LOOKUP IN THE FREQUENCY TABLE FOR
  458 02E8 B93E00             LDA   FRQTAB,Y     ; CORRESPONDING FREQUENCY PARAMETER
  459 02EB 950D               STA   V1TBA+VXIN,X ; AND PUT IT IN THE WAVE TABLE POINTER
  460 02ED B93F00             LDA   FRQTAB+1,Y   ; INCREMENT FIELD OF THE CURRENT VOICE
  461 02F0 950E               STA   V1TBA+VXIN+1,X
  462 02F2 A42A               LDY   YSAVE        ; RESTORE SAVED Y
  463 02F4 C8                 INY                ; INCREMENT Y TO POINT TO THE NEXT CODE
  464                                            ; STRING ELEMENT
  465 02F5 E018      NOTE9:   CPX   #24          ; TEST IF ALL VOICES HAVE BEEN SCANNED
  466 02F7 F054               BEQ   PLAY         ; GO PLAY THE NOTES IF SO
  467 02F9 8A                 TXA                ; BUMP THE POINTER TO THE NEXT VOICE IF NOT
  468 02FA 18                 CLC
  469 02FB 6908               ADC   #8
  470 02FD AA                 TAX
  471 02FE 4CB502             JMP   NOTE1        ; GO PROCESS THE NEXT VOICE
  472
  473                ;        PROCESS LONG NOTE COMMANDS
  474
  475 0301 A52B      LNOTE:   LDA   CMSAVE       ; GET FIRST BYTE OF CODE SEGMENT BACK
  476 0303 29F0               AND   #X'F0        ; ISOLATE PITCH FIELD
  477 0305 C960               CMP   #X'60        ; TEST IF LONG NOTE WITH ABSOLUTE PITCH
  478 0307 F007               BEQ   PCC60        ; GO PROCESS IT IF SO
  479 0309 C970               CMP   #X'70        ; TEST IF LONG NOTE WITH RELATIVE PITCH
  480 030B F008               BEQ   PCC70        ; GO PROCESS IT IF SO
  481 030D 4C3302             JMP   PCC          ; GO PROCESS PURE CONTROL COMMAND
  482
  483                ;        PROCESS ABSOLUTE PITCH BYTE
  484
  485 0310 C8        PCC60:   INY                 ; GET PITCH FROM NEXT BYTE
  486 0311 B104               LDA    (CODEPT),Y
  487 0313 950C               STA    V1TBA+VXNOT,X; PUT IT IN THE FREQUENCY TABLE
  488 0315 4C2003             JMP    LNOTE3       ; DISPLACEMENT BYTE OF THE CURRENT VOICE
  489
  490                ;        PROCESS RELATIVE PITCH BYTE
  491
  492 0318 C8        PCC70:   INY                 ; GET PITCH FROM NEXT BYTE
  493 0319 B104               LDA    (CODEPT),Y
  494 031B 18                 CLC                 ; ADD TO THE FREQUENCY TABLE DISPLACEMENT
  495 031C 750C               ADC    V1TBA+VXNOT,X; BYTE OF THE CURRENT VOICE
  496 031E 950C               STA    V1TBA+VXNOT,X; UPDATE THE FREQUENCY TABLE DISPLACEMENT
  497
  498                ;        GET CORRESPONDING FREQUENCY PARAMETER FROM THE NOTE FREQUENCY
  499                ;        TABLE.
  500
  501 0320 842A      LNOTE3:  STY    YSAVE        ; SAVE INDEX Y TEMPORARILY
  502 0322 A8                 TAY                 ; LOOKUP IN FREQUENCY TABLE THE DOUBLE
  503 0323 B93E00             LDA    FRQTAB,Y     ; PRECISION FREQUENCY PARAMETER AND MOVE
  504 0326 950D               STA    V1TBA+VXIN,X ; IT TO VXIN
  505 0328 B93F00             LDA    FRQTAB+1,Y
  506 032B 950E               STA    V1TBA+VXIN+1,X
  507 032D A42A               LDY    YSAVE        ; RESTORE INDEX Y
  508
  509                ;        PROCESS WAVEFORM FIELD
  510
  511 032F C8                 INY                 ; GET WAVEFORM TABLE NUMBER FROM NEXT BYTE
  512 0330 B104               LDA    (CODEPT),Y
  513 0332 4A                 LSRA                ; POSITION IT CORRECTLY
  514 0333 4A                 LSRA
  515 0334 4A                 LSRA
  516 0335 4A                 LSRA
  517 0336 18                 CLC
  518 0337 6503               ADC    WAVTBA+1     ; ADD TO PAGE NUMBER OF WAVEFORM ZERO
  519 0339 950B               STA    V1TBA+VXPTW,X; STORE IN WAVEFORM TABLE PAGE NUMBER
  520                                             ; BYTE OF THE CURRENT VOICE
  521
  522                ;        PROCESS DURATION FIELD
  523
  524 033B B104               LDA    (CODEPT),Y   ; GET THE SECOND BYTE BACK
  525 033D 290F               AND    #X'0F        ; ISOLATE THE DURATION DIGIT
  526 033F 842A               STY    YSAVE        ; SAVE Y AGAIN
  527 0341 A8                 TAY
  528 0342 B92E00             LDA    DURTAB-1,Y   ; GET THE CORRESPONDING DURATION BYTE
  529 0345 950F               STA    V1TBA+VXDUR,X; STORE IT IN THE DURATION BYTE OF THE
  530                                             ; SPECIFIED VOICE
  531 0347 A42A               LDY    YSAVE        ; RESTORE Y
  532 0349 C8                 INY                 ; UPDATE CODE POINTER
  533 034A 4CF502             JMP    NOTE9        ; GO UPDATE VOICE POINTER
  534
                              .PAGE  'PLAY ROUTINE'
  535                ;        PLAY THE NOTES SET UP BY THE CODE SEGMENT INTERPRETER
  536                ;        FIRST MERGE THE Y INDEX INTO THE CODE POINTER SO THAT IT POINTS
  537                ;        TO THE NEXT CODE SEGMENT AFTER THE NOTES ARE PLAYED.
  538                ;        NEXT SCAN THE DURATION FIELDS OF THE 4 VOICES TO FIND THE
  539                ;        SHORTEST.  THEN GO THROUGH THEM AGAIN AND SUBTRACT THE SHORTEST
  540                ;        DURATION FROM EACH LEAVING AT LEAST ONE OF THEM ZERO.
  541                ;        FINALLY, PLAY THE NOTES FOR THE SHORTEST DURATION AND GO BACK
  542                ;        TO THE CODE SEGMENT INTERPRETER WHEN DONE
  543
  544 034D 98        PLAY:    TYA                 ; UPDATE THE CODE POINTER IN MEMORY BY
  545 034E 18                 CLC                 ; ADDING THE Y INDEX TO IT
  546 034F 6504               ADC    CODEPT
  547 0351 8504               STA    CODEPT
  548 0353 9002               BCC    PLAY1        ; INCREMENT UPPER BYTE IF CARRY FROM LOW
  549 0355 E605               INC    CODEPT+1     ; BYTE
  550
  551                ;        SCAN THE DURATION FIELDS OF ALL OF THE VOICES TO FIND THE
  552                ;        SHORTEST
  553
  554 0357 A9FF      PLAY1:   LDA    #X'FF        ; INITIALIZE SHORTEST DURATION
  555 0359 C50F               CMP    V1TBA+VXDUR  ; TEST VOICE 1 DURATION
  556 035B 9002               BCC    PLAY2        ; SKIP IF NOT LESS THAN CURRENT MIN
  557 035D A50F               LDA    V1TBA+VXDUR
  558 035F C517      PLAY2:   CMP    V2TBA+VXDUR  ; TEST VOICE 2
  559 0361 9002               BCC    PLAY3
  560 0363 A517               LDA    V2TBA+VXDUR
  561 0365 C51F      PLAY3:   CMP    V3TBA+VXDUR  ; TEST VOICE 3
  562 0367 9002               BCC    PLAY4
  563 0369 A51F               LDA    V3TBA+VXDUR
  564 036B C527      PLAY4:   CMP    V4TBA+VXDUR  ; TEST VOICE 4
  565 036D 9002               BCC    PLAY5
  566 036F A527               LDA    V4TBA+VXDUR
  567 0371 8507      PLAY5:   STA    DUR          ; SAVE SHORTEST DURATION = PLAY DURATION
  568 0373 8508               STA    DURC         ; SET DURATION COUNTER FOR SOUND GENERATE
  569
  570                ;        4 VOICE SOUND GENERATE ROUTINE
  571                ;        ENTER WITH VARIOUS TABLE POINTERS ALREADY SET UP
  572                ;        LOOPS TEMPO*DUR TIMES
  573                ;        TOTAL LOOP TIME = 114 STATES = 8770 HZ
  574
  575 0375 A000      SOUND:   LDY    #0           ; SET Y TO ZERO FOR STRAIGHT INDIRECT
  576 0377 A606               LDX    TEMPO        ; SET X TO TEMPO COUNT
  577                                             ; COMPUTE AND OUTPUT A COMPOSITE SAMPLE
  578 0379 18        SOUND1:  CLC                 ; CLEAR CARRY
  579 037A B10A               LDA    (V1TBA+VXPTI),Y ; ADD UP 4 VOICE SAMPLES USING
  580 037C 7112      ADV2:    ADC    (V2TBA+VXPTI),Y ; INDIRECT ADDRESSING THROUGH VOICE
  581 037E 711A      ADV3:    ADC    (V3TBA+VXPTI),Y ; POINTERS INTO WAVEFORM TABLES
  582 0380 7122      ADV4:    ADC    (V4TBA+VXPTI),Y ; STRAIGHT INDIRECT WHEN Y INDEX = 0
  583 0382 8D0017             STA    DAC             ; SEND SUM TO DIGITAL-TO-ANALOG CONVERTER
  584 0385 A509               LDA    V1TBA+VXPTF  ; ADD INCREMENTS TO POINTERS FOR
  585 0387 650E               ADC    V1TBA+VXIN+1 ; THE 4 VOICES
  586 0389 8509               STA    V1TBA+VXPTF  ; FIRST FRACTIONAL PART
  587 038B A50A               LDA    V1TBA+VXPTI
  588 038D 650D               ADC    V1TBA+VXIN
  589 038F 850A               STA    V1TBA+VXPTI  ; THEN INTEGER PART
  590 0391 A511               LDA    V2TBA+VXPTF  ; DO THE SAME FOR VOICE 2
  591 0393 6516               ADC    V2TBA+VXIN+1
  592 0395 8511               STA    V2TBA+VXPTF
  593 0397 A512               LDA    V2TBA+VXPTI
  594 0399 6515               ADC    V2TBA+VXIN
  595 039B 8512               STA    V2TBA+VXPTI
  596 039D A519               LDA    V3TBA+VXPTF  ; VOICE 3
  597 039F 651E               ADC    V3TBA+VXIN+1
  598 03A1 8519               STA    V3TBA+VXPTF
  599 03A3 A51A               LDA    V3TBA+VXPTI
  600 03A5 651D               ADC    V3TBA+VXIN
  601 03A7 851A               STA    V3TBA+VXPTI
  602 03A9 A521               LDA    V4TBA+VXPTF  ; VOICE 4
  603 03AB 6526               ADC    V4TBA+VXIN+1
  604 03AD 8521               STA    V4TBA+VXPTF
  605 03AF A522               LDA    V4TBA+VXPTI
  606 03B1 6525               ADC    V4TBA+VXIN
  607 03B3 8522               STA    V4TBA+VXPTI
  608 03B5 CA                 DEX                 ; DECREMENT & CHECK TEMPO COUNT
  609 03B6 D008               BNE    TIMWAS       ; BRANCH TO TIME WASTE IF NOT RUN OUT
  610 03B8 C608               DEC    DURC         ; DECREMENT & CHECK DURATION COUNTER
  611 03BA F00C               BEQ    JPCC         ; JUMP OUT IF END OF NOTE
  612 03BC A606               LDX    TEMPO        ; RESTORE TEMPO COUNT
  613 03BE D0B9               BNE    SOUND1       ; CONTINUE PLAYING
  614 03C0 D000      TIMWAS:  BNE    TMWS1        ; 3 WASTE 12 STATES
  615 03C2 D000      TMWS1:   BNE    TMWS2        ; 3
  616 03C4 D000      TMWS2:   BNE    TMWS3        ; 3
  617 03C6 D0B1      TMWS3:   BNE    SOUND1       ; 3 CONTINUE PLAYING
  618
  619 03C8 4C3302    JPCC:    JMP    PCC          ; GO BACK TO INTERPRETER
  620
                              .PAGE  'MISCELLANEOUS SUBROUTINES'
  621                ;        SET NUMBER OF VOICES SUBROUTINE
  622                ;        THIS ROUTINE MODIFIES INSTRUCTIONS IN THE SOUND GENERATE
  623                ;        ROUTINE TO CONTROL THE NUMBER OF VOICES INCLUDED IN THE SAMPLE
  624                ;        CALCULATION, ENTER WITH NUMBER OF VOICES TO INCLUDE IN A,
  625                ;        RANGE IS 1 TO 4.  0 IS INTERPRETED AS 1.  USES INDEX X
  626
  627 03CB AA        SETNV:   TAX
  628 03CC A912               LDA    #V2TBA+VXPTI ; FIRST SET TO INCLUDE ALL 4 VOICES
  629 03CE 8D7D03             STA    ADV2+1
  630 03D1 A91A               LDA    #V3TBA+VXPTI
  631 03D3 8D7F03             STA    ADV3+1
  632 03D6 A922               LDA    #V4TBA+VXPTI
  633 03D8 8D8103             STA    ADV4+1
  634 03DB A92D               LDA    #NULSMP      ; SET UP TO ELIMINATE VOICES
  635 03DD E002               CPX    #2           ; TEST ARGUMENT TO DETERMINE HOW MANY TO
  636 03DF F00A               BEQ    ELIM3        ; ELIMINATE
  637 03E1 3005               BMI    ELIM2
  638 03E3 E003               CPX    #3
  639 03E5 F007               BEQ    ELIM4
  640 03E7 60                 RTS
  641 03E8 8D7D03    ELIM2:   STA    ADV2+1       ; ELIMINATE REQUIRED NUMBER OF VOICES
  642 03EB 8D7F03    ELIM3:   STA    ADV3+1
  643 03EE 8D8103    ELIM4:   STA    ADV4+1
  644 03F1 60                 RTS
  645
  646 0000                    .END
NO ERROR LINES
