
;        COPYRIGHT 1977 BY MICRO TECHNOLOGY UNLIMITED, BOX 4596,
;        MANCHESTER, NEW HAMPSHIRE 03108
;        PROGRAM WRITTEN BY HAL CHAMBERLIN

;        THIS PROGRAM INTERPRETS NOTRAN OBJECT CODE GENERATED BY THE
;        NOTRAN COMPILER.
;        4 NON-DYNAMIC VOICES ARE SUPPORTED.
;        AN 8-BIT UNSIGNED DIGITAL-TO-ANALOG CONVERTER IS USED FOR THE
;        AUDIO OUTPUT,
;        OUTPUT SAMPLE RATE IS 8.77 KHZ WITH A 1.0 MHZ 6502 PROCESSOR

;        THE INTERPRETIVE OBJECT CODE IS TIME-ORDERED IN MEMORY STARTING
;        AT THE ADDRESS IN "SONGA" AND ENDING AT AN END COMMAND BYTE OR
;        AN INFINITE LOOP.  EACH COMMAND IN THE OBJECT CODE CONSISTS OF
;        1, 2, OR 3 BYTES.  SOME COMMANDS ARE SPECIFICATIONS THAT TAKE
;        NO "TIME" THEMSELVES SUCH AS A TEMPO CHANGE SPECIFICATION.
;        OTHERS DIRECT THE PLAYING OF NOTES AND REQUIRE AN AMOUNT OF
;        TIME DETERMINED BY THEIR DURATION FIELD AND THE CURRENT TEMPO.

;        THE FIRST BYTE OF A COMMAND IS THE COMMAND BYTE.  IT IS SPLIT
;        INTO TWO 4 BIT FIELDS, THE PITCH FIELD (UPPER HEX DIGIT) AND
;        THE DURATION FIELD (LOWER HEX DIGIT).  THE PITCH FIELD IS
;        INTERPRETED AS A SIGNED 4 BIT BINARY NUMBER.  IT REPRESENTS A
;        PITCH "DISPLACEMENT" FROM THE LAST NOTE PLAYED BY THE VOICE
;        BEING PROCESSED.  POSITIVE VALUES SPECIFY AN ASCENDING PITCH
;        WHILE NEGATIVE VALUES SPECIFY A DESCENDING PITCH.  THE VALUE-8
;        IS USED TO SPECIFY SILENCE FOR THE AFFECTED VOICE.  THUS
;        CONSECUTIVE NOTES MAY BE AT INTERVALS OF OVER A HALF OCTAVE
;        WITHOUT REQUIRING THE MULTI-BYTE LONG NOTE SPECIFICATION TO BE
;        USED.  THE RELATIVE NATURE OF THE NOTES IS ALSO USEFUL IN
;        "MUSICAL SUBROUTINES" TO BE DESCRIBED.

;        THE DURATION FIELD SPECIFIES THE DURATION OF THE SPECIFIED
;        PITCH FOR THE CURRENT VOICE.  THE DURATION CODE IS AS FOLLOWS:

;          0 = CONTROL ESCAPE           8 = QUARTER-TRIPLET (1/6)
;          1 = WHOLE NOTE               9 = EIGHTH NOTE
;          2 = DOTTED HALF NOTE         A = DOTTED SIXTEENTH NOTE
;          3 = HALF NOTE                B = EIGHTH-TRIPLET (1/12)
;          4 = DOTTED QUARTER NOTE      C = SIXTEENTH NOTE
;          5 = HALF-TRIPLET (1/3)       D = DOTTED THIRTY-SECOND NOTE
;          6 = QUARTER NOTE             E = SIXTEENTH-TRIPLET (1/24)
;          7 = DOTTED EIGHTH NOTE       F = THIRTY-SECOND NOTE

;        NOTE THAT IF THE DURATION CODE IS ZERO THEN THE PITCH FIELD IS
;        INTERPRETED AS FOLLOWS:

;          0 = END OF SONG, RETURN TO KIM-1 MONITOR
;          1 = CHANGE OF TEMPO, NEXT BYTE IS A NEW TEMPO BYTE
;          2 = CALL TO A MUSICAL SUBROUTINE, TWO BYTE SUBROUTINE ADDRESS
;              FOLLOWS, LOW BYTE FIRST
;          3 = RETURN FROM A MUSICAL SUBROUTINE
;          4 = UNCONDITIONAL JUMP, TWO BYTE JUMP ADDRESS FOLLOWS
;          5 = SET NUMBER OF VOICES, NUMBER BETWEEN 1 AND 4 IN NEXT BYTE
;          6 = LONG NOTE SPECIFICATION WITH ABSOLUTE PITCH SPECIFICATION
;              2 ADDITIONAL BYTES FOLLOW
;          7 = LONG NOTE SPECIFICATION WITH RELATIVE PITCH SPECIFICATION
;              2 ADDITIONAL BYTES FOLLOW
;          8 = DEACTIVATE VOICE, VOICE NUMBER TO DEACTIVATE IN NEXT BYTE
;          9 = ACTIVATE VOICE, VOICE NUMBER TO ACTIVATE IN NEXT BYTE
;          A-F RESERVED FOR FUTURE EXPANSION, IF USED CAUSES RETURN TO
;              KIM MONITOR

;        A LONG NOTE SPECIFICATION CONSISTS OF TWO ADDITIONAL BYTES AS
;        FOLLOWS:
;        BYTE 1 - PITCH; IF ABSOLUTE, IT IS TREATED AS RELATIVE TO THE
;                 BEGINNING OF THE NOTE FREQUENCY TABLE.  IF RELATIVE,
;                 IT IS TREATED AS RELATIVE TO THE LAST PITCH SOUNDED
;                 BY THE CURRENT VOICE. IN EITHER CASE IT IS A SIGNED,
;                 TWOS COMPLEMENT NUMBER.
;        BYTE 2 - UPPER DIGIT, WAVEFORM TABLE NUMBER.  THIS IS ADDED
;                 TO THE PAGE ADDRESS OF THE WAVEFORM TABLE AREA TO
;                 YEILD THE PAGE ADDRESS OF THE WAVEFORM TABLE TO BE
;                 USED FOR THIS VOICE.
;                 LOWER DIGIT - DURATION CODE AS LISTED PREVIOUSLY.
;                 A ZERO DURATION IS ILLEGAL.

;        WHEN SELECTING THE WAVEFORM TABLES TO BE ASSIGNED TO THE VOICES
;        IT IS IMPORTANT THAT OVERFLOW WHEN THE VOICES ARE COMBINED IS
;        AVOIDED.  WHEN CHECKING FOR AN OVERFLOW POSSIBILITY, AN
;        INACTIVE VOICE STILL CONTRIBUTES TO THE SUM (AN INACTIVE VOICE
;        MERELY HAS A ZERO FREQUENCY) WHEREAS A DISABLED VOICE DOES NOT
;        (IT IS NOT SUMMED).  TO DETERMINE IF OVERFLOW IS POSSIBLE, ADD
;        UP THE LARGEST SAMPLE FROM THE WAVEFORM TABLE CORRESPONDING TO
;        EACH ENABLED VOICE AND VERIFY THAT THE SUM IS 255 OR LESS.  AN
;        ABSOLUTELY SAFE WAY TO AVOID OVERFLOW IS TO SPECIFY WHEN THE
;        WAVEFORM IS CREATED WITH THE FOURIER SERIES PROGRAM AN
;        AMPLITUDE OF 255/N WHERE N IS THE NUMBER OF ENABLED VOICES.
;        HOWEVER BY PROPERLY UNDERSTANDING THE OVERFLOW RESTRICTION ONE
;        MAY MAKE SOME VOICES LOUDER THAN OTHERS AND EVEN IMPLEMENT
;        LIMITED DYNAMICS.  NOTE THAT ACTIVATING OR DEACTIVATING A VOICE
;        IS NOISELESS WHEREAS ENABLING OR DISABLING ONE MAY BE
;        ACCOMPANIED BY A CLICK.

;        VOICE 1 IS ALWAYS ENABLED.  ENABLED VOICES MUST ALWAYS BE IN
;        SEQUENCE STARTING FROM VOICE 1.  AS AN EXAMPLE, IF THE NUMBER
;        OF VOICES IS SET TO 3, THEN VOICES 1 - 2 ARE EANBLED AND VOICE
;        4 IS DISABLED.

;               RULES FOR INTERPRETING NOTRAN OBJECT CODE

;        WHEN THE INTERPRETER IS INITIALLY ENTERED, ALL 4 VOICES WILL BE
;        DEACTIVATED AND INTERPRETATION WILL START AT THE ADDRESS IN
;        SONGA.  THE INTERPRETER EXPECTS TO SEE PURE CONTROL COMMANDS
;        (DURATION FIELD = 0 AND PITCH FIELD BETWEEN 0 AND B) FIRST.  AT
;        THE BEGINNING OF A SONG, AT LEAST ONE WOULD BE USED TO SET UP
;        THE TEMPO.  AT OTHER TIMES THEY ARE USED TO CHANGE THE TEMPO,
;        DEACTIVATE VOICES THAT WILL BE SILENT FOR A TIME, ACTIVATE
;        VOICES THAT HAVE BEEN IDLE, ALTER THE FLOW OF CONTROL THROUGH
;        JUMPS OR SUBROUTINE CALLS, AND TO MARK THE END OF THE SONG.

;        FOLLOWING THE PURE CONTROL COMMANDS, IF ANY, NOTE COMMANDS ARE
;        EXPECTED.  AT THE BEGINNING OF A SONG LONG NOTE COMMANDS MUST
;        BE USED TO ESTABLISH THE WAVEFORMS TO BE USED WITH EACH VOICE
;        AND ESTABLISH A PITCH REFERENCE FOR THE RELATIVE PITCHES THAT
;        MAY APPEAR LATER.  AT OTHER TIMES LONG NOTE COMMANDS MAY BE
;        USED TO CHANGE WAVEFORMS AND ADDRESS PITCHES THAT ARE
;        UNREACHABLE WITH THE RELATIVE PITCH SPECIFICATION IN A SHORT
;        NOTE COMMAND.  SHORT NOTE COMMANDS (DURATION FIELD IS NON-ZERO)
;        MAY BE FREELY INTERMIXED WITH LONG NOTE COMMANDS AND SHOULD BE
;        USED WHEN POSSIBLE TO MINIMIZE THE AMOUNT OF STORAGE REQUIRED
;        FOR A SONG.

;        NOTE COMMANDS ARE SUCCESSIVELY FETCHED, INTERPRETED, AND
;        ASSINGED IN ORDER TO ACTIVE VOICES WHOSE NOTES HAVE EXPIRED
;        UNTIL ALL OF THE ACTIVE VOICES HAVE BEEN SATISFIED.  SINCE ALL
;        NOTE COMMANDS LACK A FIELD THAT SPECIFICALLY ASSIGNS THE NOTE
;        TO A PARTICULAR VOICE, THEY ARE ASSIGNED TO EXPIRED ACTIVE
;        VOICES IN SEQUENCE STARTING WITH VOICE 1.  WHEN ALL EXPIRED
;        ACTIVE VOICES HAVE BEEN LOADED UP, THEY PLAY THEIR NOTES UNTIL
;        THE ONE WITH THE SHORTEST DURATION RUNS OUT, THEN THE
;        INTERPRETER REGAINS CONTROL EXPECTING PURE CONTROL COMMANDS
;        AGAIN.

         .zeropage           ; ORG AT PAGE 0 LOCATION 0

DAC      =      $1700        ; OUTPUT PORT ADDRESS WITH DAC
DACDIR   =      $1701        ; DATA DRIECTION REGISTER FOR DAC PORT
KIMMON   =      $1C22        ; ENTRY POINT TO KIM KEYBOARD MONITOR
ISTKPT   =      $FF          ; INITIAL VALUE OF STACK POINTER

                             ; FORMAT OF TABLE AREA FOR VOICE X
VXPTF    =      0            ; VOICE WAVE POINTER, FRACTIONAL PART
VXPTI    =      1            ; INTEGER PART
VXPTW    =      2            ; WAVE TABLE PAGE NUMBER
VXNOT    =      3            ; DISPLACEMENT IN NOTE FREQUENCY TABLE
VXIN     =      4            ; WAVE TABLE POINTER INCREMENT (FREQUENCY
                             ; PARAMETER, DOUBLE PRECISION)
VXDUR    =      6            ; NOTE DURATION

;        ADDRESSES OF OBJECT CODE AREA AND WAVEFORM TABLE AREA

SONGA:   .WORD  0            ; ADDRESS OF OBJECT CODE AREA
WAVTBA:  .WORD  0            ; ADDRESS OF WAVEFORM TABLE AREA

;        STORAGE REQUIRED BY THE INTERPRETER

CODEPT:  .WORD  0            ; OBJECT CODE POINTER
TEMPO:   .BYTE  0            ; TEMPO CONTROL VALUE
DUR:     .BYTE  0            ; EVENT DURATION
DURC:    .BYTE  0            ; EVENT DURATION COUNTER
V1TBA:   .RES   8            ; 8 BYTES FOR VOICE 1 TABLE AREA + 1 SPARE
V2TBA:   .RES   8            ; 8 BYTES FOR VOICE 2 TABLE AREA + 1 SPARE
V3TBA:   .RES   8            ; 8 BYTES FOR VOICE 3 TABLE AREA + 1 SPARE
V4TBA:   .RES   8            ; 8 BYTES FOR VOICE 4 TABLE AREA + 1 SPARE
XSAVE:   .BYTE  0            ; AREA FOR QUICK SAVE OF X
YSAVE:   .BYTE  0            ; AREA FOR QUICK SAVE OF Y
CMSAVE:  .BYTE  0            ; AREA FOR SAVING COMMAND BYTE
CTLM:    .BYTE  $0F          ; MASK FOR TESTING DURATION FIELD
NULSMP:  .WORD  FRQTAB       ; ADDRESS OF NULL SAMPLE FOR USE IN
                             ; EFFECTIVELY REDUCING NUMBER OF VOICES
                             ; ADDED UP

         ; NOTE DURATION TABLE

DURTAB:  .BYTE  192          ; 1 WHOLE NOTE
         .BYTE  144          ; 2 DOTTED HALF NOTE
         .BYTE  96           ; 3 HALF NOTE
         .BYTE  72           ; 4 DOTTED QUARTER NOTE
         .BYTE  64           ; 5 HALF NOTE TRIPLET
         .BYTE  48           ; 6 QUARTER NOTE
         .BYTE  36           ; 7 DOTTED EIGHTH NOTE
         .BYTE  32           ; 8 QUARTER NOTE TRIPLET
         .BYTE  24           ; 9 EIGHTH NOTE
         .BYTE  18           ; A DOTTED SIXTEENTH NOTE
         .BYTE  16           ; B EIGHTH NOTE TRIPLET
         .BYTE  12           ; C SIXTEENTH NOTE
         .BYTE  9            ; D DOTTED 1/32 NOTE
         .BYTE  8            ; E SIXTEENTH NOTE TRIPLET
         .BYTE  6            ; F 1/32 NOTE

;        NOTE FREQUENCY TABLE FOR 8.772 KHZ SAMPLE RATE
;        RANGE FROM C1 (32.7 HZ) TO C6 (1046.5 HZ)
;                               ID  NOTE  FREQ.   INCR.
FRQTAB:  .BYTE  0,0          ;  00  SILENCE
         .BYTE  0,244        ;  02  C1    32.702  .95445
         .BYTE  1,3          ;  04  C1#   34.647  1.0112
         .BYTE  1,18         ;  06  D1    36.707  1.0713
         .BYTE  1,35         ;  08  D1#   38.891  1.1350
         .BYTE  1,52         ;  0A  E1    41.204  1.2025
         .BYTE  1,70         ;  0C  F1    43.654  1.2740
         .BYTE  1,90         ;  0E  F1#   46.249  1.3498
         .BYTE  1,110        ;  10  G1    48.999  1.4300
         .BYTE  1,132        ;  12  G1#   51.915  1.5151
         .BYTE  1,155        ;  14  A1    55.000  1.6052
         .BYTE  1,179        ;  16  A1#   58.270  1.7006
         .BYTE  1,205        ;  18  B1    61.735  1.8017
         .BYTE  1,233        ;  1A  C1    65.405  1.9089
         .BYTE  2,6          ;  1C  C1#   69.295  2.0224
         .BYTE  2,37         ;  1E  D2    73.415  2.1427
         .BYTE  2,69         ;  20  D2#   77.783  2.2701
         .BYTE  2,104        ;  22  E2    82.408  2.4051
         .BYTE  2,140        ;  24  F2    87.308  2.5481
         .BYTE  2,179        ;  26  F2#   92.498  2,6996
         .BYTE  2,220        ;  28  G2    97.998  2.8601
         .BYTE  3,8          ;  2A  G2#   103.83  3.0302
         .BYTE  3,54         ;  2C  A2    110.00  3.2104
         .BYTE  3,103        ;  2E  A2#   116.54  3.4013
         .BYTE  3,154        ;  30  B2    123.47  3.6035
         .BYTE  3,209        ;  32  C3    130.81  3.8178
         .BYTE  4,11         ;  34  C3#   138.59  4.0448
         .BYTE  4,73         ;  36  D3    146.83  4.2854
         .BYTE  4,138        ;  38  D3#   155.57  4.5402
         .BYTE  4,207        ;  3A  E3    164.82  4.8102
         .BYTE  5,25         ;  3C  F3    174.62  5.0962
         .BYTE  5,102        ;  3E  F3#   185.00  5.3992
         .BYTE  5,184        ;  40  G3    196.00  5.7203
         .BYTE  6,15         ;  42  G3#   207.65  6.0604
         .BYTE  6,108        ;  44  A3    220.00  6.4208
         .BYTE  6,205        ;  46  A3#   233.08  6.8026
         .BYTE  7,53         ;  48  B3    246.94  7.2071
         .BYTE  7,163        ;  4A  C4    261.62  7.6356
         .BYTE  8,23         ;  4C  C4#   277.18  8.0897
         .BYTE  8,146        ;  4E  D4    293.66  8.5707
         .BYTE  9,21         ;  50  D4#   311.13  9.0804
         .BYTE  9,159        ;  52  E4    329.63  9.6203
         .BYTE  10,49        ;  54  F4    349.23  10.1924
         .BYTE  10,204       ;  56  F4#   369.99  10.7984
         .BYTE  11,113       ;  58  G4    391.99  11.4405
         .BYTE  12,31        ;  5A  G4    415.30  12.1208
         .BYTE  12,215       ;  5C  A4    440.00  12.8416
         .BYTE  13,155       ;  5E  A4#   466.16  13.6052
         .BYTE  14,106       ;  60  B4    493.88  14.4142
         .BYTE  15,69        ;  62  C5    523.24  15.2713
         .BYTE  16,46        ;  64  C5#   554.36  16.1794
         .BYTE  17,36        ;  66  D5    587.32  17.1414
         .BYTE  18,41        ;  68  D5#   622.26  18.1607
         .BYTE  19,62        ;  6A  E5    659.26  19.2406
         .BYTE  20,98        ;  6C  F5    698.46  20.3847
         .BYTE  21,153       ;  6E  F5#   739.98  21.5969
         .BYTE  22,226       ;  70  G5    783.98  22.8811
         .BYTE  24,62        ;  72  G5#   830.60  24.2417
         .BYTE  25,175       ;  74  A5    880.00  25.6831
         .BYTE  27,54        ;  76  A5#   932.32  27.2103
         .BYTE  28,212       ;  78  B5    987.76  28.8283
         .BYTE  30,139       ;  7A  C6    1046.5  30.5426

;        JUMP TABLE FOR INTERPRETING PURE CONTROL COMMANDS

JADDR:   .WORD  0            ; INDIRECT JUMP POINTER
JTAB:    .WORD  KIMMON       ; 00 RETURN TO KIM MONITOR
         .WORD  PCC10        ; 10 TEMPO SET
         .WORD  PCC20        ; 20 MUSICAL SUBROUTINE CALL
         .WORD  PCC30        ; 30 RETURN FROM MUSICAL SUBROUTINE
         .WORD  PCC40        ; 40 UNCONDITIONAL JUMP
         .WORD  PCC50        ; 90 SET NUMBER OF VOICES
         .WORD  NOTE         ; 60 LONG NOTE WITH ABSOLUTE PITCH
         .WORD  NOTE         ; 70 LONG NOTE WITH RELATIVE PITCH
         .WORD  PCC80        ; 80 ACTIVATE VOICE
         .WORD  PCC90        ; 90 DEACTIVATE VOICE
         .WORD  KIMMON       ; A0 UNDEFINED
         .WORD  KIMMON       ; B0 UNDEFINED
         .WORD  KIMMON       ; C0 UNDEFINED
         .WORD  KIMMON       ; D0 UNDEFINED
         .WORD  KIMMON       ; E0 UNDEFINED
         .WORD  KIMMON       ; F0 UNDEFINED

;        INITIALIZATION ROUTINE
;        INITIALIZE THE MUSIC HARDWARE, SET UP THE OBJECT CODE POINTER,
;        AND DEACTIVATE ALL 4 VOICES

         .code               ; START INTERPRETER AT 200

MUSIC:   LDA    #$FF         ; SET DAC PORT DATA DIRECTION REGISTER TO
         STA    DACDIR       ; OUTPUT
         CLD                 ; INSURE BINARY ARITHMETIC
         LDX    #ISTKPT      ; INITIALIZE STACK POINTER
         TXS
         LDA    #0           ; ZERO THE PREVIOUS DURATION
         STA    DUR
         LDA    SONGA        ; INITIALIZE OBJECT CODE POINTER TO
         STA    CODEPT       ; BEGINNING OF ORJECT CODE
         LDA    SONGA+1
         STA    CODEPT+1

         LDX    #0           ; INITIALIZE ALL 4 VOICES
DEACT:   LDA    #0
         STA    V1TBA+VXIN,X ; ZERO THE WAVE TABLE INCREMENT FOR SILENCE
         STA    V1TBA+VXIN+1,X
         LDA    #$FF         ; SET THE VOICE DURATION TO FF TO
         STA    V1TBA+VXDUR,X; DEACTIVATE
         LDA    WAVTBA+1     ; INITIALLY ASSIGN WAVEFORM 1 TO ALL VOICES
         STA    V1TBA+VXPTW,X
         TXA                 ; BUMP INDEX UP TO NEXT VOICE
         CLC
         ADC    #8
         TAX
         CMP    #32          ; TEST IF DONE
         BNE    DEACT        ; LOOP UNTIL 4 VOICES DONE
         LDA    #4           ; SET NUMBER OF VOICES TO 4
         JSR    SETNV

;        INTERPRET CODE SEGMENTS UNTIL ALL ACTIVE, UNEXPIRED VOICES HAVE
;        BEEN SATISFIED AND THEN GO TO THE SOUND GENERATION ROUTINE

;        INITIALLY A "PURE CONTROL COMMAND" IS EXPECTED

PCC:     LDY    #0           ; INITIALIZE INDEX Y TO POINT TO FIRST BYTE
                             ; OF CODE SEGMENT
PCC1:    LDA    (CODEPT),Y   ; GET FIRST BYTE OF CODE SEGMENT
         BIT    CTLM         ; TEST IF LOW HEX DIGIT IS ZERO
         BEQ    PCC2
         JMP    NOTE         ; JUMP IF NOT, IT IS A SHORT NOTE COMMAND
PCC2:    LSR A               ; PERFORM A VECTOR JUMP ON THE HIGH HEX
         LSR A               ; DIGIT
         LSR A
         TAX
         LDA    JTAB,X
         STA    JADDR
         LDA    JTAB+1,X
         STA    JADDR+1
         JMP    (JADDR)

;        PROCESS TEMPO CHANGE COMMAND

PCC10:   INY                 ; GET NEXT BYTE FROM CODE STRING
         LDA    (CODEPT),Y
         STA    TEMPO        ; UPDATE THE TEMPO
         INY
         JMP    PCC1         ; GO FOR NEXT COMMAND

;        PROCESS MUSICAL SUBROUTINE CALL

PCC20:   LDA    CODEPT       ; SAVE CURRENT VALUE OF OBJECT CODE POINTER
         PHA                 ; ON THE STACK
         LDA    CODEPT+1
         PHA                 ; AND PROCESS THE NEXT 2 BYTES AS AN
         TYA                 ; UNCONDITIONAL JUMP
         PHA

;        PROCESS AN UNCONDITIONAL JUMP

PCC40:   INY                 ; GET NEXT TWO BYTES FROM THE CODE STRING
         LDA    (CODEPT),Y
         CLC                 ; AND ADD THEM TO THE CODE STRING ORIGIN
         ADC    SONGA        ; FOR RELATIVE ADDRESSING WITHIN OBJECT
         TAX                 ; CODE
         INY
         LDA    (CODEPT),Y
         ADC    SONGA+1
         STA    CODEPT+1     ; STORE THEM IN THE CODE STRING POINTER
         STX    CODEPT
         LDY    #0           ; ZERO THE INDEX FACTOR
         JMP    PCC1         ; GO FOR NEXT COMMAND

;        PROCESS A RETURN FROM MUSICAL SUBROUTINE

PCC30:   PLA                 ; POP THE SAVED CODE POINTER FROM THE STACK
         TAY
         PLA
         STA    CODEPT+1
         PLA
         STA    CODEPT
         INY                 ; INCREMENT THE SAVED INDEX FACTOR BY 3
         INY
         INY
         JMP    PCC1         ; AND GO FOR THE NEXT COMMAND

;        PROCESS A SET NUMBER OF VOICES COMMAND

PCC50:   INY                 ; GET SPECIFIED NUMBER OF VOICES
         LDA    (CODEPT),Y   ; FROM NEXT CODE BYTE
         JSR    SETNV        ; DO INSTRUCTION MODIFICATION IN SOUND
                             ; GENERATE ROUTINE TO SET THE NUMBER OF
         INY                 ; VOICES
         JMP    PCC1         ; GO FOR NEXT COMMAND

;        PROCESS A DEACTIVATE VOICE COMMAND

PCC80:   INY                 ; GET SPECIFIED VOICE NUMBER TIMES 8
         LDA    (CODEPT),Y
         AND    #$03         ; RESTRICT RANGE TO 0 - 3
         ASL A
         ASL A
         ASL A
         TAX                 ; PUT IT INTO X
         LDA    #$FF         ; SET THE DURATION BYTE IN THE SPECIFIED
         STA    V1TBA+VXDUR,X; VOICE TO FF TO DEACTIVATE IT
         LDA    #0           ; ZERO THE WAVE TABLE INCREMENT FOR SILENCE
         STA    V1TBA+VXIN,X
         STA    V1TBA+VXIN+1,X
         INY                 ; INCREMENT THE CODE STRING POINTER
         JMP    PCC1         ; GO FOR NEXT COMMAND

;        PROCESS AN ACTIVATE VOICE COMMAND

PCC90:   INY                 ; COMPUTE SPECIFIED VOICE NUMBER TIMES 8
         LDA    (CODEPT),Y
         AND    #$03
         ASL A
         ASL A
         ASL A
         TAX                 ; PUT IT INTO INDEX X
         LDA    #0           ; SET THE DURATION BYTE IN THE SPECIFIED
         STA    V1TBA+VXDUR,X; VOICE TO 0 TO ACTIVATE IT
         INY                 ; INCREMENT THE CODE STRING POINTER
         JMP    PCC1         ; GO FOR NEXT COMMAND

;        NOTE COMMANDS ARE EXPECTED HERE.  SCAN THROUGH THE VOICES IN
;        SEQUENCE SKIPPING ANY INACTIVE ONES.  IF VXDUR IS ZERO, FETCH A
;        COMMAND FROM THE CODE STRING WHICH IS EXPECTED TO BE A NOTE
;        COMMAND AND INTERPRET IT ASSIGNING THE RESULTS TO THE CURRENT
;        VOICE.  WHEN ALL VOICES HAVE BEEN PROCESSED, GO PLAY THE NOTES.

NOTE:    LDX   #0           ; INITIALIZE CURRENT VOICE POINTER
NOTE1:   LDA   V1TBA+VXDUR,X; GET DURATION BYTE OF CURRENT VOICE
         BEQ   NOTE2        ; JUMP IF NEWLY ACTIVATED
         CMP   #$FF
         BEQ   NOTE9        ; SKIP THIS VOICE IF INACTIVE
         SEC                ; SUBTRACT PREVIOUS DURATION
         SBC   DUR
         STA   V1TBA+VXDUR,X; STORE RESULT BACK
         BNE   NOTE9        ; SKIP THIS VOICE IF UNEXPIRED
NOTE2:   LDA   (CODEPT),Y   ; GET A COMMAND BYTE
         STA   CMSAVE       ; SAVE THE COMMAND BYTE
         AND   #$0F         ; ISOLATE THE DURATION FIELD AND
         BEQ   LNOTE        ; JUMP OUT IF NOT A SHORT NOTE COMMAND
         STY   YSAVE        ; SAVE Y
         TAY                ; GET DURATION VALUE CORRESPONDING TO
         LDA   DURTAB-1,Y   ; CONTENTS OF DURATION FIELD AND
         STA   V1TBA+VXDUR,X; PUT INTO DURATION BYTE OF CURRENT VOICE
         LDA   CMSAVE       ; GET THE COMMAND BYTE BACK
         AND   #$F0         ; ISOLATE THE PITCH DISPLACEMENT
         CLC                ; CONVERT TWO'S COMPLEMENT TO EXCESS 8
         ADC   #$80
         BEQ   NOTE3        ; SKIP AHEAD IF -8 = REST
         LSR A              ; RIGHT JUSTIFY THE PITCH DISPLACEMENT
         LSR A              ; TIMES TWO
         LSR A
         ADC   V1TBA+VXNOT,X; ADD RESULT TO CURRENT PITCH BYTE
         CLC
         ADC   #<(-16)      ; SUBTRACT OUT THE EXCESS 8 OFFSET
         STA   V1TBA+VXNOT,X; UPDATE THE CURRENT PITCH BYTE
NOTE3:   TAY                ; LOOKUP IN THE FREQUENCY TABLE FOR
         LDA   FRQTAB,Y     ; CORRESPONDING FREQUENCY PARAMETER
         STA   V1TBA+VXIN,X ; AND PUT IT IN THE WAVE TABLE POINTER
         LDA   FRQTAB+1,Y   ; INCREMENT FIELD OF THE CURRENT VOICE
         STA   V1TBA+VXIN+1,X
         LDY   YSAVE        ; RESTORE SAVED Y
         INY                ; INCREMENT Y TO POINT TO THE NEXT CODE
                            ; STRING ELEMENT
NOTE9:   CPX   #24          ; TEST IF ALL VOICES HAVE BEEN SCANNED
         BEQ   PLAY         ; GO PLAY THE NOTES IF SO
         TXA                ; BUMP THE POINTER TO THE NEXT VOICE IF NOT
         CLC
         ADC   #8
         TAX
         JMP   NOTE1        ; GO PROCESS THE NEXT VOICE

;        PROCESS LONG NOTE COMMANDS

LNOTE:   LDA   CMSAVE       ; GET FIRST BYTE OF CODE SEGMENT BACK
         AND   #$F0         ; ISOLATE PITCH FIELD
         CMP   #$60         ; TEST IF LONG NOTE WITH ABSOLUTE PITCH
         BEQ   PCC60        ; GO PROCESS IT IF SO
         CMP   #$70         ; TEST IF LONG NOTE WITH RELATIVE PITCH
         BEQ   PCC70        ; GO PROCESS IT IF SO
         JMP   PCC          ; GO PROCESS PURE CONTROL COMMAND

;        PROCESS ABSOLUTE PITCH BYTE

PCC60:   INY                 ; GET PITCH FROM NEXT BYTE
         LDA    (CODEPT),Y
         STA    V1TBA+VXNOT,X; PUT IT IN THE FREQUENCY TABLE
         JMP    LNOTE3       ; DISPLACEMENT BYTE OF THE CURRENT VOICE

;        PROCESS RELATIVE PITCH BYTE

PCC70:   INY                 ; GET PITCH FROM NEXT BYTE
         LDA    (CODEPT),Y
         CLC                 ; ADD TO THE FREQUENCY TABLE DISPLACEMENT
         ADC    V1TBA+VXNOT,X; BYTE OF THE CURRENT VOICE
         STA    V1TBA+VXNOT,X; UPDATE THE FREQUENCY TABLE DISPLACEMENT

;        GET CORRESPONDING FREQUENCY PARAMETER FROM THE NOTE FREQUENCY
;        TABLE.

LNOTE3:  STY    YSAVE        ; SAVE INDEX Y TEMPORARILY
         TAY                 ; LOOKUP IN FREQUENCY TABLE THE DOUBLE
         LDA    FRQTAB,Y     ; PRECISION FREQUENCY PARAMETER AND MOVE
         STA    V1TBA+VXIN,X ; IT TO VXIN
         LDA    FRQTAB+1,Y
         STA    V1TBA+VXIN+1,X
         LDY    YSAVE        ; RESTORE INDEX Y

;        PROCESS WAVEFORM FIELD

         INY                 ; GET WAVEFORM TABLE NUMBER FROM NEXT BYTE
         LDA    (CODEPT),Y
         LSR A               ; POSITION IT CORRECTLY
         LSR A
         LSR A
         LSR A
         CLC
         ADC    WAVTBA+1     ; ADD TO PAGE NUMBER OF WAVEFORM ZERO
         STA    V1TBA+VXPTW,X; STORE IN WAVEFORM TABLE PAGE NUMBER
                             ; BYTE OF THE CURRENT VOICE

;        PROCESS DURATION FIELD

         LDA    (CODEPT),Y   ; GET THE SECOND BYTE BACK
         AND    #$0F         ; ISOLATE THE DURATION DIGIT
         STY    YSAVE        ; SAVE Y AGAIN
         TAY
         LDA    DURTAB-1,Y   ; GET THE CORRESPONDING DURATION BYTE
         STA    V1TBA+VXDUR,X; STORE IT IN THE DURATION BYTE OF THE
                             ; SPECIFIED VOICE
         LDY    YSAVE        ; RESTORE Y
         INY                 ; UPDATE CODE POINTER
         JMP    NOTE9        ; GO UPDATE VOICE POINTER

;        PLAY THE NOTES SET UP BY THE CODE SEGMENT INTERPRETER
;        FIRST MERGE THE Y INDEX INTO THE CODE POINTER SO THAT IT POINTS
;        TO THE NEXT CODE SEGMENT AFTER THE NOTES ARE PLAYED.
;        NEXT SCAN THE DURATION FIELDS OF THE 4 VOICES TO FIND THE
;        SHORTEST.  THEN GO THROUGH THEM AGAIN AND SUBTRACT THE SHORTEST
;        DURATION FROM EACH LEAVING AT LEAST ONE OF THEM ZERO.
;        FINALLY, PLAY THE NOTES FOR THE SHORTEST DURATION AND GO BACK
;        TO THE CODE SEGMENT INTERPRETER WHEN DONE

PLAY:    TYA                 ; UPDATE THE CODE POINTER IN MEMORY BY
         CLC                 ; ADDING THE Y INDEX TO IT
         ADC    CODEPT
         STA    CODEPT
         BCC    PLAY1        ; INCREMENT UPPER BYTE IF CARRY FROM LOW
         INC    CODEPT+1     ; BYTE

;        SCAN THE DURATION FIELDS OF ALL OF THE VOICES TO FIND THE
;        SHORTEST

PLAY1:   LDA    #$FF         ; INITIALIZE SHORTEST DURATION
         CMP    V1TBA+VXDUR  ; TEST VOICE 1 DURATION
         BCC    PLAY2        ; SKIP IF NOT LESS THAN CURRENT MIN
         LDA    V1TBA+VXDUR
PLAY2:   CMP    V2TBA+VXDUR  ; TEST VOICE 2
         BCC    PLAY3
         LDA    V2TBA+VXDUR
PLAY3:   CMP    V3TBA+VXDUR  ; TEST VOICE 3
         BCC    PLAY4
         LDA    V3TBA+VXDUR
PLAY4:   CMP    V4TBA+VXDUR  ; TEST VOICE 4
         BCC    PLAY5
         LDA    V4TBA+VXDUR
PLAY5:   STA    DUR          ; SAVE SHORTEST DURATION = PLAY DURATION
         STA    DURC         ; SET DURATION COUNTER FOR SOUND GENERATE

;        4 VOICE SOUND GENERATE ROUTINE
;        ENTER WITH VARIOUS TABLE POINTERS ALREADY SET UP
;        LOOPS TEMPO*DUR TIMES
;        TOTAL LOOP TIME = 114 STATES = 8770 HZ

SOUND:   LDY    #0           ; SET Y TO ZERO FOR STRAIGHT INDIRECT
         LDX    TEMPO        ; SET X TO TEMPO COUNT
                             ; COMPUTE AND OUTPUT A COMPOSITE SAMPLE
SOUND1:  CLC                 ; CLEAR CARRY
         LDA    (V1TBA+VXPTI),Y ; ADD UP 4 VOICE SAMPLES USING
ADV2:    ADC    (V2TBA+VXPTI),Y ; INDIRECT ADDRESSING THROUGH VOICE
ADV3:    ADC    (V3TBA+VXPTI),Y ; POINTERS INTO WAVEFORM TABLES
ADV4:    ADC    (V4TBA+VXPTI),Y ; STRAIGHT INDIRECT WHEN Y INDEX = 0
         STA    DAC             ; SEND SUM TO DIGITAL-TO-ANALOG CONVERTER
         LDA    V1TBA+VXPTF  ; ADD INCREMENTS TO POINTERS FOR
         ADC    V1TBA+VXIN+1 ; THE 4 VOICES
         STA    V1TBA+VXPTF  ; FIRST FRACTIONAL PART
         LDA    V1TBA+VXPTI
         ADC    V1TBA+VXIN
         STA    V1TBA+VXPTI  ; THEN INTEGER PART
         LDA    V2TBA+VXPTF  ; DO THE SAME FOR VOICE 2
         ADC    V2TBA+VXIN+1
         STA    V2TBA+VXPTF
         LDA    V2TBA+VXPTI
         ADC    V2TBA+VXIN
         STA    V2TBA+VXPTI
         LDA    V3TBA+VXPTF  ; VOICE 3
         ADC    V3TBA+VXIN+1
         STA    V3TBA+VXPTF
         LDA    V3TBA+VXPTI
         ADC    V3TBA+VXIN
         STA    V3TBA+VXPTI
         LDA    V4TBA+VXPTF  ; VOICE 4
         ADC    V4TBA+VXIN+1
         STA    V4TBA+VXPTF
         LDA    V4TBA+VXPTI
         ADC    V4TBA+VXIN
         STA    V4TBA+VXPTI
         DEX                 ; DECREMENT & CHECK TEMPO COUNT
         BNE    TIMWAS       ; BRANCH TO TIME WASTE IF NOT RUN OUT
         DEC    DURC         ; DECREMENT & CHECK DURATION COUNTER
         BEQ    JPCC         ; JUMP OUT IF END OF NOTE
         LDX    TEMPO        ; RESTORE TEMPO COUNT
         BNE    SOUND1       ; CONTINUE PLAYING
TIMWAS:  BNE    TMWS1        ; 3 WASTE 12 STATES
TMWS1:   BNE    TMWS2        ; 3
TMWS2:   BNE    TMWS3        ; 3
TMWS3:   BNE    SOUND1       ; 3 CONTINUE PLAYING

JPCC:    JMP    PCC          ; GO BACK TO INTERPRETER

;        SET NUMBER OF VOICES SUBROUTINE
;        THIS ROUTINE MODIFIES INSTRUCTIONS IN THE SOUND GENERATE
;        ROUTINE TO CONTROL THE NUMBER OF VOICES INCLUDED IN THE SAMPLE
;        CALCULATION, ENTER WITH NUMBER OF VOICES TO INCLUDE IN A,
;        RANGE IS 1 TO 4.  0 IS INTERPRETED AS 1.  USES INDEX X

SETNV:   TAX
         LDA    #V2TBA+VXPTI ; FIRST SET TO INCLUDE ALL 4 VOICES
         STA    ADV2+1
         LDA    #V3TBA+VXPTI
         STA    ADV3+1
         LDA    #V4TBA+VXPTI
         STA    ADV4+1
         LDA    #NULSMP      ; SET UP TO ELIMINATE VOICES
         CPX    #2           ; TEST ARGUMENT TO DETERMINE HOW MANY TO
         BEQ    ELIM3        ; ELIMINATE
         BMI    ELIM2
         CPX    #3
         BEQ    ELIM4
         RTS
ELIM2:   STA    ADV2+1       ; ELIMINATE REQUIRED NUMBER OF VOICES
ELIM3:   STA    ADV3+1
ELIM4:   STA    ADV4+1
         RTS

         .END
